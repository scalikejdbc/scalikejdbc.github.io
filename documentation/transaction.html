<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <!-- Use title if it's in the page YAML frontmatter -->
    <title>Transaction - ScalikeJDBC</title>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"/>
    <script type="text/javascript" src="//code.jquery.com/jquery-1.11.0.min.js"></script>
    <link href="/stylesheets/all.css" rel="stylesheet" />
    <script src="/javascripts/all.js"></script>
  </head>
  <body>
    <div class="container">
    <div class="navbar" role="navigation" id="header">
      <div class="container">
        <div class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li><a class="navbar-brand" href="/">ScalikeJDBC</a></li>
            <li><a href="https://groups.google.com/group/scalikejdbc-users-group">Users Group</a></li>
            <li><a href="https://github.com/scalikejdbc/scalikejdbc">GitHub</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>
    <div class="col-xs-6 pull-right" style="height:50px;">
      <gcse:searchbox-only></gcse:searchbox-only>
    </div>
      <div class="col-xs-9 left">
        <div class="content">
          <h2 id="transaction">Transaction</h2>

<hr/>

<h3 id="readonly-block-session">#readOnly block / session</h3>

<hr/>

<p>This code block executes queries in read-only mode. This means that no update/execute operations are allowed.</p>
<div class="highlight"><pre class="highlight scala"><code><span class="k">val</span> <span class="nv">names</span> <span class="k">=</span> <span class="nc">DB</span> <span class="n">readOnly</span> <span class="o">{</span> <span class="k">implicit</span> <span class="n">session</span> <span class="k">=&gt;</span>
  <span class="n">sql</span><span class="s">"select name from emp"</span><span class="o">.</span><span class="py">map</span> <span class="o">{</span> <span class="n">rs</span> <span class="k">=&gt;</span> <span class="nv">rs</span><span class="o">.</span><span class="py">string</span><span class="o">(</span><span class="s">"name"</span><span class="o">)</span> <span class="o">}.</span><span class="py">list</span><span class="o">.</span><span class="py">apply</span><span class="o">()</span>
<span class="o">}</span>

<span class="c1">// Alternatively, you can use a session variable this way:</span>
<span class="k">implicit</span> <span class="k">val</span> <span class="nv">session</span> <span class="k">=</span> <span class="nv">DB</span><span class="o">.</span><span class="py">readOnlySession</span>
<span class="k">try</span> <span class="o">{</span>
  <span class="k">val</span> <span class="nv">names</span> <span class="k">=</span> <span class="n">sql</span><span class="s">"select name from emp"</span><span class="o">.</span><span class="py">map</span> <span class="o">{</span> <span class="n">rs</span> <span class="k">=&gt;</span> <span class="nv">rs</span><span class="o">.</span><span class="py">string</span><span class="o">(</span><span class="s">"name"</span><span class="o">)</span> <span class="o">}.</span><span class="py">list</span><span class="o">.</span><span class="py">apply</span><span class="o">()</span>
  <span class="c1">// do something</span>
<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
  <span class="nv">session</span><span class="o">.</span><span class="py">close</span><span class="o">()</span>
<span class="o">}</span>
</code></pre></div>
<p>If you run an <code>update</code> operation within read-only mode, the code throws <code>java.sql.SQLException</code>:</p>
<div class="highlight"><pre class="highlight scala"><code><span class="nc">DB</span> <span class="n">readOnly</span> <span class="o">{</span> <span class="k">implicit</span> <span class="n">session</span> <span class="k">=&gt;</span>
  <span class="n">sql</span><span class="s">"update emp set name = ${name} where id = ${id}"</span><span class="o">.</span><span class="py">update</span><span class="o">.</span><span class="py">apply</span><span class="o">()</span>
<span class="o">}</span> <span class="c1">// will throw java.sql.SQLException</span>
</code></pre></div>
<hr/>

<h3 id="autocommit-block-session">#autoCommit block / session</h3>

<hr/>

<p>This code block executes queries / update operations in auto-commit mode.</p>
<div class="highlight"><pre class="highlight scala"><code><span class="k">val</span> <span class="nv">count</span> <span class="k">=</span> <span class="nc">DB</span> <span class="n">autoCommit</span> <span class="o">{</span> <span class="k">implicit</span> <span class="n">session</span> <span class="k">=&gt;</span>
  <span class="n">sql</span><span class="s">"update emp set name = ${name} where id = ${id}"</span><span class="o">.</span><span class="py">update</span><span class="o">.</span><span class="py">apply</span><span class="o">()</span>
<span class="o">}</span>
</code></pre></div>
<p>When using <code>autoCommitSession</code>, an operation will be executed in auto-commit mode too.</p>
<div class="highlight"><pre class="highlight scala"><code><span class="k">implicit</span> <span class="k">val</span> <span class="nv">session</span> <span class="k">=</span> <span class="nv">DB</span><span class="o">.</span><span class="py">autoCommitSession</span>
<span class="k">try</span> <span class="o">{</span>
  <span class="n">sql</span><span class="s">"update emp set name = ${name1} where id = ${id1}"</span><span class="o">.</span><span class="py">update</span><span class="o">.</span><span class="py">apply</span><span class="o">()</span> <span class="c1">// auto-commit</span>
  <span class="n">sql</span><span class="s">"update emp set name = ${name2} where id = ${id2}"</span><span class="o">.</span><span class="py">update</span><span class="o">.</span><span class="py">apply</span><span class="o">()</span> <span class="c1">// auto-commit</span>
<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span> <span class="nv">session</span><span class="o">.</span><span class="py">close</span><span class="o">()</span> <span class="o">}</span>
</code></pre></div>
<hr/>

<h3 id="localtx-block">#localTx block</h3>

<hr/>

<p>This code block executes queries / update operations in block-scoped transactions. When an Exception was thrown within the block, the ongoing transaction will be cancelled and then the transaction will be rolled back automatically.</p>
<div class="highlight"><pre class="highlight scala"><code><span class="k">val</span> <span class="nv">count</span> <span class="k">=</span> <span class="nc">DB</span> <span class="n">localTx</span> <span class="o">{</span> <span class="k">implicit</span> <span class="n">session</span> <span class="k">=&gt;</span>
  <span class="c1">// --- transcation scope start ---</span>
  <span class="n">sql</span><span class="s">"update emp set name = ${name1} where id = ${id1}"</span><span class="o">.</span><span class="py">update</span><span class="o">.</span><span class="py">apply</span><span class="o">()</span>
  <span class="n">sql</span><span class="s">"update emp set name = ${name2} where id = ${id2}"</span><span class="o">.</span><span class="py">update</span><span class="o">.</span><span class="py">apply</span><span class="o">()</span>
  <span class="c1">// --- transaction scope end ---</span>
<span class="o">}</span>
</code></pre></div>
<p>The <code>TxBoundary</code> class provides a differnt transaction boundary beyond throwing an Exception (This feature is available since version 2.2.0):</p>
<div class="highlight"><pre class="highlight scala"><code><span class="k">import</span> <span class="nn">scalikejdbc._</span>
<span class="k">import</span> <span class="nn">scala.util.Try</span>
<span class="k">import</span> <span class="nn">scalikejdbc.TxBoundary.Try._</span>

<span class="k">val</span> <span class="nv">result</span><span class="k">:</span> <span class="kt">Try</span><span class="o">[</span><span class="kt">Result</span><span class="o">]</span> <span class="k">=</span> <span class="nc">DB</span> <span class="n">localTx</span> <span class="o">{</span> <span class="k">implicit</span> <span class="n">session</span> <span class="k">=&gt;</span>
  <span class="nc">Try</span> <span class="o">{</span> <span class="nf">doSomeStaff</span><span class="o">()</span> <span class="o">}</span>
<span class="o">}</span>
<span class="c1">// localTx rolls back when `result` is `Failure`</span>
<span class="c1">// https://www.scala-lang.org/api/current/scala/util/Try.html</span>
</code></pre></div>
<p>The Built-in type class instances are <code>Try</code>, <code>Either</code> and <code>Future</code>. You can use them by having <code>import scalikejdbc.TxBoundary,***._</code> in your code.</p>

<hr/>

<h3 id="futurelocaltx-block">#futureLocalTx block</h3>

<hr/>

<p>The <code>futureLocalTx</code> block uses <code>Future</code>&lsquo;s state as the transaction boundary. When any of the <code>Future</code> operations fails, the transaction will be rolled back automatically. </p>
<div class="highlight"><pre class="highlight scala"><code><span class="k">object</span> <span class="nc">FutureDB</span> <span class="o">{</span>
  <span class="k">implicit</span> <span class="k">val</span> <span class="nv">ec</span> <span class="k">=</span> <span class="n">myOwnExecutorContext</span>
  <span class="k">def</span> <span class="nf">updateFirstName</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">firstName</span><span class="k">:</span> <span class="kt">String</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">session</span><span class="k">:</span> <span class="kt">DBSession</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="nc">Future</span> <span class="o">{</span> 
      <span class="n">blocking</span> <span class="o">{</span>
        <span class="nv">session</span><span class="o">.</span><span class="py">update</span><span class="o">(</span><span class="s">"update users set first_name = ? where id = ?"</span><span class="o">,</span> <span class="n">firstName</span><span class="o">,</span> <span class="n">id</span><span class="o">)</span>
      <span class="o">}</span> 
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="k">def</span> <span class="nf">updateLastName</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">lastName</span><span class="k">:</span> <span class="kt">String</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">session</span><span class="k">:</span> <span class="kt">DBSession</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="nc">Future</span> <span class="o">{</span> 
      <span class="n">blocking</span> <span class="o">{</span>
        <span class="nv">session</span><span class="o">.</span><span class="py">update</span><span class="o">(</span><span class="s">"update users set last_name = ? where id = ?"</span><span class="o">,</span> <span class="n">lastName</span><span class="o">,</span> <span class="n">id</span><span class="o">)</span>
      <span class="o">}</span> 
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">Example</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">FutureDB._</span>
  <span class="k">val</span> <span class="nv">fResult</span> <span class="k">=</span> <span class="nc">DB</span> <span class="n">futureLocalTx</span> <span class="o">{</span> <span class="k">implicit</span> <span class="n">s</span> <span class="k">=&gt;</span>  
    <span class="nf">updateFirstName</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="s">"John"</span><span class="o">).</span><span class="py">flatMap</span><span class="o">(</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="nf">updateLastName</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="s">"Smith"</span><span class="o">))</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="nv">Example</span><span class="o">.</span><span class="py">fResult</span><span class="o">.</span><span class="py">foreach</span><span class="o">(</span><span class="nf">println</span><span class="o">(</span><span class="k">_</span><span class="o">))</span>
<span class="c1">// #=&gt; 1</span>
</code></pre></div>
<p>Alternatively, you can use <code>TxBoundary[Future[A]]</code> too:</p>
<div class="highlight"><pre class="highlight scala"><code><span class="k">import</span> <span class="nn">scalikejdbc.TxBoundary.Future._</span>
<span class="k">val</span> <span class="nv">fResult</span> <span class="k">=</span> <span class="nc">DB</span> <span class="n">localTx</span> <span class="o">{</span> <span class="k">implicit</span> <span class="n">s</span> <span class="k">=&gt;</span>  
  <span class="nf">updateFirstName</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="s">"John"</span><span class="o">).</span><span class="py">flatMap</span><span class="o">(</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="nf">updateLastName</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="s">"Smith"</span><span class="o">))</span>
<span class="o">}</span>
</code></pre></div>
<hr/>

<h3 id="working-with-io-monads">Working with IO monads</h3>

<hr/>

<p>This section guides you on how to implement a transaction boundary for IO monads.</p>

<hr/>

<h4 id="io-monad-minimal-example">IO monad minimal example</h4>

<hr/>

<p>Let&rsquo;s say you have a custom IO monad called <code>MyIO</code>:</p>
<div class="highlight"><pre class="highlight scala"><code><span class="k">sealed</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">MyIO</span><span class="o">[</span><span class="kt">+A</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">MyIO._</span>

  <span class="k">def</span> <span class="nf">flatMap</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="nc">MyIO</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span><span class="k">:</span> <span class="kt">MyIO</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">this</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">Delay</span><span class="o">(</span><span class="n">thunk</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Delay</span><span class="o">(()</span> <span class="k">=&gt;</span> <span class="nf">f</span><span class="o">(</span><span class="nf">thunk</span><span class="o">()).</span><span class="py">run</span><span class="o">())</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="nf">map</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="n">B</span><span class="o">)</span><span class="k">:</span> <span class="kt">MyIO</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span> <span class="k">=</span> <span class="nf">flatMap</span><span class="o">(</span><span class="n">x</span> <span class="k">=&gt;</span> <span class="nc">MyIO</span><span class="o">(</span><span class="nf">f</span><span class="o">(</span><span class="n">x</span><span class="o">)))</span>

  <span class="k">def</span> <span class="nf">run</span><span class="o">()</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">this</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">Delay</span><span class="o">(</span><span class="n">f</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nv">f</span><span class="o">.</span><span class="py">apply</span><span class="o">()</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="nf">attempt</span><span class="k">:</span> <span class="kt">MyIO</span><span class="o">[</span><span class="kt">Either</span><span class="o">[</span><span class="kt">Throwable</span>, <span class="kt">A</span><span class="o">]]</span> <span class="k">=</span>
    <span class="nc">MyIO</span><span class="o">(</span><span class="k">try</span> <span class="o">{</span>
      <span class="nc">Right</span><span class="o">(</span><span class="nf">run</span><span class="o">())</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nv">scala</span><span class="o">.</span><span class="py">util</span><span class="o">.</span><span class="py">control</span><span class="o">.</span><span class="py">NonFatal</span><span class="o">(</span><span class="n">t</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Left</span><span class="o">(</span><span class="n">t</span><span class="o">)</span>
    <span class="o">})</span>

<span class="o">}</span>

<span class="k">object</span> <span class="nc">MyIO</span> <span class="o">{</span>
  <span class="k">def</span> <span class="nf">apply</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">a</span><span class="k">:</span> <span class="o">=&gt;</span> <span class="n">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">MyIO</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Delay</span><span class="o">(()</span> <span class="k">=&gt;</span> <span class="n">a</span><span class="o">)</span>

  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">Delay</span><span class="o">[</span><span class="kt">+A</span><span class="o">](</span><span class="n">thunk</span><span class="k">:</span> <span class="o">()</span> <span class="o">=&gt;</span> <span class="n">A</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">MyIO</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>
<span class="o">}</span>
</code></pre></div>
<p>Here is an example of <code>TxBoundary</code> typeclass instance for <code>MyIO[A]</code> type:</p>
<div class="highlight"><pre class="highlight scala"><code><span class="k">import</span> <span class="nn">scalikejdbc._</span>

<span class="k">implicit</span> <span class="k">def</span> <span class="nf">myIOTxBoundary</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span><span class="k">:</span> <span class="kt">TxBoundary</span><span class="o">[</span><span class="kt">MyIO</span><span class="o">[</span><span class="kt">A</span><span class="o">]]</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">TxBoundary</span><span class="o">[</span><span class="kt">MyIO</span><span class="o">[</span><span class="kt">A</span><span class="o">]]</span> <span class="o">{</span>

  <span class="k">def</span> <span class="nf">finishTx</span><span class="o">(</span><span class="n">result</span><span class="k">:</span> <span class="kt">MyIO</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="n">tx</span><span class="k">:</span> <span class="kt">Tx</span><span class="o">)</span><span class="k">:</span> <span class="kt">MyIO</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="nv">result</span><span class="o">.</span><span class="py">attempt</span><span class="o">.</span><span class="py">flatMap</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">Right</span><span class="o">(</span><span class="n">a</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">MyIO</span><span class="o">(</span><span class="nv">tx</span><span class="o">.</span><span class="py">commit</span><span class="o">()).</span><span class="py">flatMap</span><span class="o">(</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="nc">MyIO</span><span class="o">(</span><span class="n">a</span><span class="o">))</span>
      <span class="k">case</span> <span class="nc">Left</span><span class="o">(</span><span class="n">e</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">MyIO</span><span class="o">(</span><span class="nv">tx</span><span class="o">.</span><span class="py">rollback</span><span class="o">()).</span><span class="py">flatMap</span><span class="o">(</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="nc">MyIO</span><span class="o">(</span><span class="k">throw</span> <span class="n">e</span><span class="o">))</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">closeConnection</span><span class="o">(</span><span class="n">result</span><span class="k">:</span> <span class="kt">MyIO</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="n">doClose</span><span class="k">:</span> <span class="o">()</span> <span class="o">=&gt;</span> <span class="nc">Unit</span><span class="o">)</span><span class="k">:</span> <span class="kt">MyIO</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">{</span>
      <span class="n">x</span> <span class="k">&lt;-</span> <span class="nv">result</span><span class="o">.</span><span class="py">attempt</span>
      <span class="k">_</span> <span class="k">&lt;-</span> <span class="nc">MyIO</span><span class="o">(</span><span class="nf">doClose</span><span class="o">())</span>
      <span class="n">a</span> <span class="k">&lt;-</span> <span class="nc">MyIO</span><span class="o">(</span><span class="nv">x</span><span class="o">.</span><span class="py">fold</span><span class="o">(</span><span class="k">throw</span> <span class="k">_</span><span class="o">,</span> <span class="n">identity</span><span class="o">))</span>
    <span class="o">}</span> <span class="k">yield</span> <span class="n">a</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>Woth the above custom <code>TxBoundary</code>, you can use <code>localTx</code> code blocks in a simple way sa below:</p>
<div class="highlight"><pre class="highlight scala"><code><span class="k">import</span> <span class="nn">scalikejdbc._</span>
<span class="k">type</span> <span class="kt">A</span> <span class="o">=</span> <span class="o">???</span>
<span class="k">def</span> <span class="nf">asyncExecution</span><span class="k">:</span> <span class="kt">DBSession</span> <span class="o">=&gt;</span> <span class="nc">MyIO</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
<span class="c1">// default</span>
<span class="nv">DB</span><span class="o">.</span><span class="py">localTx</span><span class="o">(</span><span class="n">asyncExecution</span><span class="o">)(</span><span class="n">boundary</span> <span class="k">=</span> <span class="n">myIOTxBoundary</span><span class="o">)</span>
<span class="c1">// named</span>
<span class="nc">NamedDB</span><span class="o">(</span><span class="s">"named"</span><span class="o">).</span><span class="py">localTx</span><span class="o">(</span><span class="n">asyncExecution</span><span class="o">)(</span><span class="n">boundary</span> <span class="k">=</span> <span class="n">myIOTxBoundary</span><span class="o">)</span>
</code></pre></div>
<hr/>

<h4 id="cats-effect-io-example">Cats Effect IO example</h4>

<hr/>

<p>This section guides on how to define your own custom <code>TxBoundary</code> typeclass instance for <code>cats.effect.IO[A]</code>.</p>

<p><code>cats.effect.IO</code> offers two ways to handle completion/cancellation as below. You can use <code>guaranteeCase</code> for commit/rollback operations while going with <code>guarantee</code> for connection closure.</p>
<div class="highlight"><pre class="highlight scala"><code><span class="k">import</span> <span class="nn">scalikejdbc._</span>
<span class="k">import</span> <span class="nn">cats.effect._</span>

<span class="k">implicit</span> <span class="k">def</span> <span class="nf">catsEffectIOTxBoundary</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span><span class="k">:</span> <span class="kt">TxBoundary</span><span class="o">[</span><span class="kt">IO</span><span class="o">[</span><span class="kt">A</span><span class="o">]]</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">TxBoundary</span><span class="o">[</span><span class="kt">IO</span><span class="o">[</span><span class="kt">A</span><span class="o">]]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="nf">finishTx</span><span class="o">(</span><span class="n">result</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="n">tx</span><span class="k">:</span> <span class="kt">Tx</span><span class="o">)</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span>
    <span class="nv">result</span><span class="o">.</span><span class="py">guaranteeCase</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nv">ExitCase</span><span class="o">.</span><span class="py">Completed</span> <span class="k">=&gt;</span> <span class="nc">IO</span><span class="o">(</span><span class="nv">tx</span><span class="o">.</span><span class="py">commit</span><span class="o">())</span>
      <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="nc">IO</span><span class="o">(</span><span class="nv">tx</span><span class="o">.</span><span class="py">rollback</span><span class="o">())</span>
    <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">closeConnection</span><span class="o">(</span><span class="n">result</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="n">doClose</span><span class="k">:</span> <span class="o">()</span> <span class="o">=&gt;</span> <span class="nc">Unit</span><span class="o">)</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span>
    <span class="nv">result</span><span class="o">.</span><span class="py">guarantee</span><span class="o">(</span><span class="nc">IO</span><span class="o">(</span><span class="nf">doClose</span><span class="o">()))</span>
<span class="o">}</span>
</code></pre></div>
<p>To take control of all the side-effects that happen within a <code>localTx</code> code block, you can use <code>suspend</code> method to wrap the code blocks using <code>localTx</code>:</p>
<div class="highlight"><pre class="highlight scala"><code><span class="k">import</span> <span class="nn">scalikejdbc._</span>
<span class="k">import</span> <span class="nn">cats.effect._</span>

<span class="k">type</span> <span class="kt">A</span> <span class="o">=</span> <span class="o">???</span>

<span class="k">def</span> <span class="nf">ioExecution</span><span class="k">:</span> <span class="kt">DBSession</span> <span class="o">=&gt;</span> <span class="nc">IO</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>

<span class="c1">// default</span>
<span class="nv">IO</span><span class="o">.</span><span class="py">suspend</span> <span class="o">{</span>
  <span class="nv">DB</span><span class="o">.</span><span class="py">localTx</span><span class="o">(</span><span class="n">ioExecution</span><span class="o">)(</span><span class="n">boundary</span> <span class="k">=</span> <span class="n">catsEffectIOTxBoundary</span><span class="o">)</span>
<span class="o">}</span>

<span class="c1">// named</span>
<span class="nv">IO</span><span class="o">.</span><span class="py">suspend</span> <span class="o">{</span>
  <span class="nc">NamedDB</span><span class="o">(</span><span class="s">"named"</span><span class="o">).</span><span class="py">localTx</span><span class="o">(</span><span class="n">ioExecution</span><span class="o">)(</span><span class="n">boundary</span> <span class="k">=</span> <span class="n">catsEffectIOTxBoundary</span><span class="o">)</span>
<span class="o">}</span>

</code></pre></div>
<hr/>

<h3 id="withintx-block-session">#withinTx block / session</h3>

<hr/>

<p>This code block joins an exsting transcation and executes queries / update operations with it.</p>

<p>In this case, your code is responsible to manage all transactional operations (such as <code>Tx#begin()</code>, <code>Tx#rollback()</code> or <code>Tx#commit()</code>). ScalikeJDBC never does anything under the hood.</p>
<div class="highlight"><pre class="highlight scala"><code><span class="k">val</span> <span class="nv">db</span> <span class="k">=</span> <span class="nc">DB</span><span class="o">(</span><span class="n">conn</span><span class="o">)</span>
<span class="k">try</span> <span class="o">{</span>
  <span class="nv">db</span><span class="o">.</span><span class="py">begin</span><span class="o">()</span>
  <span class="k">val</span> <span class="nv">names</span> <span class="k">=</span> <span class="n">db</span> <span class="n">withinTx</span> <span class="o">{</span> <span class="k">implicit</span> <span class="n">session</span> <span class="k">=&gt;</span>
    <span class="c1">// if a transaction has not been started, IllegalStateException will be thrown</span>
    <span class="n">sql</span><span class="s">"select name from emp"</span><span class="o">.</span><span class="py">map</span> <span class="o">{</span> <span class="n">rs</span> <span class="k">=&gt;</span> <span class="nv">rs</span><span class="o">.</span><span class="py">string</span><span class="o">(</span><span class="s">"name"</span><span class="o">)</span> <span class="o">}.</span><span class="py">list</span><span class="o">.</span><span class="py">apply</span><span class="o">()</span>
  <span class="o">}</span>
  <span class="nv">db</span><span class="o">.</span><span class="py">rollback</span><span class="o">()</span> <span class="c1">// it might throw Exception</span>
<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span> <span class="nv">db</span><span class="o">.</span><span class="py">close</span><span class="o">()</span> <span class="o">}</span>

<span class="k">val</span> <span class="nv">db</span> <span class="k">=</span> <span class="nc">DB</span><span class="o">(</span><span class="n">conn</span><span class="o">)</span>
<span class="k">try</span> <span class="o">{</span>
  <span class="nv">db</span><span class="o">.</span><span class="py">begin</span><span class="o">()</span>
  <span class="k">implicit</span> <span class="k">val</span> <span class="nv">session</span> <span class="k">=</span> <span class="nv">db</span><span class="o">.</span><span class="py">withinTxSession</span><span class="o">()</span>
  <span class="k">val</span> <span class="nv">names</span> <span class="k">=</span> <span class="n">sql</span><span class="s">"select name from emp"</span><span class="o">.</span><span class="py">map</span> <span class="o">{</span> <span class="n">rs</span> <span class="k">=&gt;</span> <span class="nv">rs</span><span class="o">.</span><span class="py">string</span><span class="o">(</span><span class="s">"name"</span><span class="o">)</span> <span class="o">}.</span><span class="py">list</span><span class="o">.</span><span class="py">apply</span><span class="o">()</span>
  <span class="nv">db</span><span class="o">.</span><span class="py">rollbackIfActive</span><span class="o">()</span> <span class="c1">// it NEVER throws Exception</span>
<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span> <span class="nv">db</span><span class="o">.</span><span class="py">close</span><span class="o">()</span> <span class="o">}</span>
</code></pre></div>
          <hr/>
          <div class="alert alert-warning small">
            If this webpage has a typo or something wrong, Please report or fix it. <a href="/contribution.html">How?</a>
          </div>
        </div>
      </div>

      <div class="col-xs-3 right">
        <div class="content small">
          <h5>Latest version</h5>
          <hr/>
          <p><a href="/documentation/setup.html">Setup</a></p>
          <p><a href="/documentation/configuration.html">Configuration</a></p>
          <p><a href="/documentation/connection-pool.html">Connection Pool</a></p>
          <p><a href="/documentation/operations.html">Operations</a></p>
          <p><a href="/documentation/transaction.html">Transaction</a></p>
          <p><a href="/documentation/auto-session.html">Auto Session</a></p>
          <p><a href="/documentation/sql-interpolation.html">SQLInterpolation</a></p>
          <p><a href="/documentation/query-dsl.html">QueryDSL</a></p>
          <p><a href="/documentation/one-to-x.html">One-to-x API</a></p>
          <p><a href="/documentation/auto-macros.html">Auto Macros</a></p>
          <p><a href="/documentation/query-inspector.html">Logging / Query Inspector</a></p>
          <p><a href="/documentation/orm.html">O/R Mapper</a></p>
          <p><a href="/documentation/reverse-engineering.html">Reverse Engineering</a></p>
          <p><a href="/documentation/testing.html">Testing</a></p>
          <p><a href="/documentation/playframework-support.html">Play Framework</a></p>
          <p><a href="/documentation/reactivestreams-support.html">Reactive Streams</a></p>
          <p><a href="/documentation/dbconsole.html">dbconsole</a></p>
          <p><a href="https://www.javadoc.io/doc/org.scalikejdbc/scalikejdbc-core_2.13/4.3.5">Core API Doc</a></p>
          <p><a href="/documentation/faq.html">FAQ</a></p>
          <p><a href="/documentation/testimonials.html">Testimonials</a></p>
          <p><a href="/contribution.html">Contribution</a></p>
          <hr/>
          <h5>Older Versions</h5>
          <hr/>
          <p><a href="/documentation/2.x/">version 2.x</a></p>
          <p><a href="/documentation/1.x/">version 1.x</a></p>
        </div>
      </div>
    </div>
    </div>
    <script type="text/javascript" src="//netdna.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script>
(function() {
var cx = '000372347144050476309:fnw5lotlq6o';
var gcse = document.createElement('script');
gcse.type = 'text/javascript';
gcse.async = true;
gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//cse.google.com/cse.js?cx=' + cx;
var s = document.getElementsByTagName('script')[0];
s.parentNode.insertBefore(gcse, s);
})();
</script>
  </body>
</html>
